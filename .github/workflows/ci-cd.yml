name: SurfPulse CI/CD (DEV -> STG -> PRD)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy-dev:
    name: DEV - Build, Deploy, Smoke Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4

      - name: Debug - list files
        run: |
          echo "PWD:"
          pwd
          echo "LS ROOT:"
          ls -la
          echo "FIND docker-compose*:"
          find . -maxdepth 2 -type f -name "docker-compose*"

      - name: Build + Deploy (DEV)
        run: |
          ls -la
          docker compose -f ./docker-compose.yml -f ./docker-compose.dev.yml up -d --build

      - name: Smoke Tests (DEV)
        run: |
          set -e

          echo "Aguardando gateway (porta 5000)..."
          for i in {1..30}; do
            if curl -sSf http://localhost:5000/health >/dev/null; then
              echo "Gateway OK!"
              break
            fi
            echo "Ainda nao... ($i/30)"
            sleep 2
          done

          echo "Teste /api/report"
          curl -sSf "http://localhost:5000/api/report?spot=carcavelos" >/dev/null

          echo "Teste /internal/send-daily"
          curl -sSf -X POST "http://localhost:5000/internal/send-daily?spot=carcavelos" \
            -H "X-Internal-Token: dev-token" >/dev/null

          echo "DEV OK"

      - name: Logs (se falhar)
        if: failure()
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.dev.yml ps
          docker compose -f ./docker-compose.yml -f ./docker-compose.dev.yml logs --no-color --tail=200

      - name: Cleanup (DEV)
        if: always()
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.dev.yml down -v


  deploy-stg:
    name: STG - Build, Deploy, Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-dev

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4

      - name: Debug - list files
        run: |
          echo "PWD:"
          pwd
          echo "LS ROOT:"
          ls -la
          echo "FIND docker-compose*:"
          find . -maxdepth 2 -type f -name "docker-compose*"

      - name: Build + Deploy (STG)
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.stg.yml up -d --build

      - name: Smoke Tests (STG)
        run: |
          set -e

          echo "Aguardando gateway (porta 5000)..."
          for i in {1..30}; do
            if curl -sSf http://localhost:5000/health >/dev/null; then
              echo "Gateway OK!"
              break
            fi
            echo "Ainda nao... ($i/30)"
            sleep 2
          done

          echo "Teste /api/report"
          curl -sSf "http://localhost:5000/api/report?spot=nazare" >/dev/null

          echo "Teste /internal/send-daily"
          curl -sSf -X POST "http://localhost:5000/internal/send-daily?spot=nazare" \
            -H "X-Internal-Token: dev-token" >/dev/null

          echo "STG OK"

      - name: Logs (se falhar)
        if: failure()
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.stg.yml ps
          docker compose -f ./docker-compose.yml -f ./docker-compose.stg.yml logs --no-color --tail=200

      - name: Cleanup (STG)
        if: always()
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.stg.yml down -v


  deploy-prd:
    name: PRD - Build, Deploy, Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-stg

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4

      - name: Debug - list files
        run: |
          echo "PWD:"
          pwd
          echo "LS ROOT:"
          ls -la
          echo "FIND docker-compose*:"
          find . -maxdepth 2 -type f -name "docker-compose*"

      - name: Build + Deploy (PRD)
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.prd.yml up -d --build

      - name: Smoke Tests (PRD)
        run: |
          set -e

          echo "Aguardando gateway (porta 5000)..."
          for i in {1..30}; do
            if curl -sSf http://localhost:5000/health >/dev/null; then
              echo "Gateway OK!"
              break
            fi
            echo "Ainda nao... ($i/30)"
            sleep 2
          done

          echo "Teste /api/report"
          curl -sSf "http://localhost:5000/api/report?spot=ericeira" >/dev/null

          echo "Teste /internal/send-daily"
          curl -sSf -X POST "http://localhost:5000/internal/send-daily?spot=ericeira" \
            -H "X-Internal-Token: dev-token" >/dev/null

          echo "PRD OK"

      - name: Logs (se falhar)
        if: failure()
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.prd.yml ps
          docker compose -f ./docker-compose.yml -f ./docker-compose.prd.yml logs --no-color --tail=200

      - name: Cleanup (PRD)
        if: always()
        run: |
          docker compose -f ./docker-compose.yml -f ./docker-compose.prd.yml down -v
