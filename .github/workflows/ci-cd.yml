name: SurfPulse CI/CD (DEV -> STG -> PRD)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:

  quality-gate:
    name: Quality Gate - Tests + Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          pip install pytest bandit pip-audit

      - name: Install project requirements
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests
        run: pytest -q

      - name: SAST Scan (Bandit)
        run: bandit -r . -ll

      # ðŸ”¥ pip-audit SEM quebrar pipeline (gera relatÃ³rio)
      - name: Dependency vulnerability scan (pip-audit report)
        run: |
          pip-audit -r requirements.txt -f markdown -o pip-audit-report.md || true
          cat pip-audit-report.md || true

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.md


  deploy-dev:
    name: DEV - Build, Deploy, Smoke Tests
    runs-on: ubuntu-latest
    needs: quality-gate

    steps:
      - uses: actions/checkout@v4

      - name: Build + Deploy DEV
        run: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build

      - name: Smoke tests DEV
        run: |
          for i in {1..30}; do
            curl -s http://localhost:5000/health && break
            sleep 2
          done

      - name: Cleanup DEV
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.dev.yml down -v


  deploy-stg:
    name: STG - Build, Deploy, Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-dev

    steps:
      - uses: actions/checkout@v4

      - name: Build + Deploy STG
        run: docker compose -f docker-compose.yml -f docker-compose.stg.yml up -d --build

      - name: Smoke tests STG
        run: |
          for i in {1..30}; do
            curl -s http://localhost:5000/health && break
            sleep 2
          done

      - name: Cleanup STG
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.stg.yml down -v


  deploy-prd:
    name: PRD - Build, Deploy, Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-stg

    steps:
      - uses: actions/checkout@v4

      - name: Build + Deploy PRD
        run: docker compose -f docker-compose.yml -f docker-compose.prd.yml up -d --build

      - name: Smoke tests PRD
        run: |
          for i in {1..30}; do
            curl -s http://localhost:5000/health && break
            sleep 2
          done

      - name: Cleanup PRD
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.prd.yml down -v
